<!DOCTYPE html>
<html> 
<head>
    <title>üè≠ Setup - Gate Controller</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; 
            margin: 0; 
            background: #f5f5f5; 
            font-size: 14px;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .nav-header { 
            background: white; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .nav-brand h1 { margin: 0; color: #333; }
        .user-info { color: #666; font-size: 12px; }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .nav-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
        }
        .nav-btn:hover { background: #5a6268; }
        .nav-btn.active { background: #667eea; }
        
        .logout-btn { 
            background: #dc3545; 
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold;
        }
        .logout-btn:hover { background: #c82333; }
        
        .card { 
            background: white; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        .add-device-form {
            display: grid;
            grid-template-columns: 1fr 120px auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }
        
        .add-device-form input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .add-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .add-btn:hover { background: #218838; }
        
        .devices-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .devices-table th,
        .devices-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .devices-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        
        .devices-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-activated { background: #d4edda; color: #155724; }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 0 2px;
        }
        
        .btn-edit { background: #17a2b8; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-activate { background: #28a745; color: white; }
        
        .bulk-actions {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .bulk-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .search-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-filters input,
        .search-filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #007bff;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-header { flex-direction: column; align-items: stretch; }
            .nav-buttons { justify-content: center; }
            .add-device-form { grid-template-columns: 1fr; }
            .search-filters { flex-direction: column; align-items: stretch; }
            .devices-table { font-size: 12px; }
        }
    </style>
    <link rel="stylesheet" href="/public/styles.css">
</head>
<body>
    <div class="container">
        <!-- Navigation Header -->
<!-- ==================== UNIFIED NAVIGATION COMPONENT ==================== -->
<!-- This navigation should be IDENTICAL across all screens -->
<!-- Copy this entire block to: dashboard.html, system.html, devices.html, manufacturing.html -->

<div class="nav-header">
    <div class="nav-brand">
        <h1 id="pageTitle">üö™ Gate Controller</h1>
        <div class="user-info">
            {{userName}} ({{userEmail}})<br>
            <span class="org-badge">{{organizationName}}</span>
            <span class="role-badge {{#if isSuperAdmin}}superadmin-badge{{/if}}">{{userRole}}</span>
        </div>
    </div>
    
    <nav class="nav-buttons">
        <!-- Home - Available to ALL users -->
        <button class="nav-btn" onclick="navigateTo('/dashboard')" data-page="dashboard">
            üè† Home
        </button>
        
        <!-- System - SuperAdmin ONLY -->
        <button class="nav-btn" onclick="navigateTo('/system')" data-page="system" 
                style="display: {{showSuperAdminFeatures}}">
            ‚öôÔ∏è System
        </button>
        
<!-- NEW VERSION - Admin+ only -->
<button class="nav-btn" onclick="navigateTo('/devices')" data-page="devices"
        style="display: {{showAdminFeatures}}">
    üì± Devices
</button>
        
        <!-- Manufacturing DB - SuperAdmin ONLY -->
        <button class="nav-btn" onclick="navigateTo('/manufacturing')" data-page="manufacturing" 
                style="display: {{showSuperAdminFeatures}}">
            üè≠ Setup
        </button>
        
        <!-- Organizations - SuperAdmin ONLY (Modal on Dashboard, Page on others) -->
        <button class="nav-btn" onclick="handleOrganizationsClick()" data-page="organizations" 
                style="display: {{showSuperAdminFeatures}}">
            üè¢ Organizations
        </button>
    </nav>
    
    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
    <!-- MOBILE Hamburger Button (ADD THIS) -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
</div>
<!-- ==================== MOBILE MENU DRAWER ==================== -->
<div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="toggleMobileMenu()"></div>

<div class="mobile-menu-drawer" id="mobileMenuDrawer">
    <div class="mobile-menu-header">
        <h2>üö™ Menu</h2>
        <button class="mobile-menu-close" onclick="toggleMobileMenu()">√ó</button>
    </div>
    
    <div class="mobile-menu-content">
        <!-- User Info -->
        <div class="mobile-user-info">
            <strong>{{userName}}</strong><br>
            {{userEmail}}<br>
            <span class="org-badge">{{organizationName}}</span>
            <span class="role-badge">{{userRole}}</span>
        </div>
        
        <!-- Menu Items -->
        <button class="mobile-menu-item" onclick="navigateToMobile('/dashboard')" data-mobile-page="dashboard">
            üè† Home
        </button>
        
        <button class="mobile-menu-item" onclick="navigateToMobile('/system')" data-mobile-page="system"
                style="display: {{showSuperAdminFeatures}}">
            ‚öôÔ∏è System
        </button>
        
        <button class="mobile-menu-item" onclick="navigateToMobile('/devices')" data-mobile-page="devices"
                style="display: {{showAdminFeatures}}">
            üì± Devices
        </button>
        
<button class="mobile-menu-item active" onclick="navigateToMobile('/manufacturing')" data-mobile-page="manufacturing"
        style="display: {{showSuperAdminFeatures}}">
    üè≠ Setup
</button>
        
        <button class="mobile-menu-item" onclick="handleOrganizationsClickMobile()" data-mobile-page="organizations"
                style="display: {{showSuperAdminFeatures}}">
            üè¢ Organizations
        </button>
        
        <button class="mobile-menu-item mobile-menu-logout" onclick="logout()">
            üö™ Logout
        </button>
    </div>
</div>
<script>
// Handle Organizations button click - Modal on Dashboard, navigation on other pages
function handleOrganizationsClick() {
    const currentPage = window.location.pathname.replace('/', '') || 'dashboard';
    
    if (currentPage === 'dashboard') {
        // On dashboard, open modal
        showOrganizationsModal();
    } else {
        // On other pages, navigate to dashboard and open modal
        window.location.href = '/dashboard?openOrganizations=true';
    }
}

// Set active navigation button based on current page
document.addEventListener('DOMContentLoaded', function() {
    const currentPage = window.location.pathname.replace('/', '') || 'dashboard';
    const navButtons = document.querySelectorAll('.nav-btn[data-page]');
// Add to each page's DOMContentLoaded
document.getElementById('pageTitle').textContent = 'üè≠ Setup'; // Example

    navButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.page === currentPage) {
            btn.classList.add('active');
        }
    });
});
</script>
        
        <!-- Statistics Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalDevices">0</div>
                <div class="stat-label">Total Devices</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingDevices">0</div>
                <div class="stat-label">Pending Activation</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activatedDevices">0</div>
                <div class="stat-label">Activated</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayProduction">0</div>
                <div class="stat-label">Today's Production</div>
            </div>
        </div>
        
        <!-- Quick Links Card -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3 style="color: white; margin-bottom: 15px;">üîÑ Firmware Management</h3>
            <p style="margin-bottom: 15px; opacity: 0.9;">
                Manage OTA firmware updates for all ESP32 devices
            </p>
            <button class="nav-btn" onclick="window.open('/firmware-management', '_blank')" 
                    style="background: white; color: #667eea; padding: 12px 24px; font-size: 16px;">
                üì¶ Open Firmware Manager
            </button>
        </div>
        
        <!-- Add New Device -->
        <div class="card">        
        <!-- Add New Device -->
        <div class="card">
            <h3>‚ûï Add New Device</h3>
            <div class="add-device-form">
                <input type="text" id="newSerial" placeholder="Device Serial (e.g., ESP32_67890)" maxlength="20">
                <input type="text" id="newPin" placeholder="PIN (6 digits)" maxlength="6" pattern="[0-9]{6}">
                <button class="add-btn" onclick="addDevice()">üì¶ Add Device</button>
            </div>
            <p style="color: #666; font-size: 12px; margin: 10px 0 0 0;">
                Serial format: ESP32_XXXXX or GC_XXXXX | PIN: 6-digit numeric code
            </p>
        </div>
        
        <!-- Search and Filters -->
        <div class="card">
            <div class="search-filters">
                <input type="text" id="searchSerial" placeholder="Search by serial..." onkeyup="filterDevices()">
                <select id="statusFilter" onchange="filterDevices()">
                    <option value="all">All Status</option>
                    <option value="pending">Pending Only</option>
                    <option value="activated">Activated Only</option>
                </select>
                <select id="sortBy" onchange="sortDevices()">
                    <option value="serial">Sort by Serial</option>
                    <option value="created">Sort by Created Date</option>
                    <option value="status">Sort by Status</option>
                </select>
                <button class="add-btn" onclick="exportDevices()">üì§ Export CSV</button>
            </div>
        </div>
        
        <!-- Bulk Actions -->
        <div class="bulk-actions">
            <label>
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> Select All
            </label>
            <button class="bulk-btn" onclick="bulkActivate()">üîß Bulk Activate</button>
            <button class="bulk-btn" onclick="bulkDelete()">üóëÔ∏è Bulk Delete</button>
            <span id="selectedCount">0 selected</span>
        </div>
        
        <!-- Devices Table -->
        <div class="card">
            <h3>üì¶ Manufacturing Devices</h3>
            <table class="devices-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="headerCheckbox" onchange="toggleSelectAll()">
                        </th>
                        <th>Serial Number</th>
                        <th>PIN</th>
                        <th>Status</th>
                        <th>Created Date</th>
                        <th>Activated Date</th>
                        <th>Activated By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="devicesTableBody">
                    <!-- Devices will be populated here -->
                </tbody>
            </table>
            
            <div id="noDevicesMessage" style="text-align: center; padding: 40px; display: none;">
                <h4>üì¶ No Devices Found</h4>
                <p>No manufacturing devices match your current filter criteria.</p>
                <p>Add new devices using the form above.</p>
            </div>
        </div>
    </div>

        <script>
    let manufacturingDevicesJSON = `{{manufacturingDevicesData}}`;
    console.log('Raw JSON from server:', manufacturingDevicesJSON);

    let manufacturingDevices = [];
    try {
        manufacturingDevices = JSON.parse(manufacturingDevicesJSON);
        console.log('‚úÖ Parsed devices:', manufacturingDevices);
    } catch (error) {
        console.error('‚ùå JSON Parse Error:', error);
        console.error('Failed to parse:', manufacturingDevicesJSON);
        manufacturingDevices = [];
    }

    let filteredDevices = [...manufacturingDevices];
    let selectedDevices = new Set();


        
        function navigateTo(path) {
            window.location.href = path;
        }
        
        async function logout() {
            try {
                await fetch('/dashboard/logout', { method: 'POST' });
                window.location.href = '/dashboard';
            } catch (error) {
                alert('Logout error: ' + error.message);
            }
        }
        
        async function addDevice() {
            const serial = document.getElementById('newSerial').value.trim();
            const pin = document.getElementById('newPin').value.trim();
            
            if (!serial || !pin) {
                alert('Please enter both serial number and PIN');
                return;
            }
            
            if (!/^[A-Z0-9_]{5,20}$/.test(serial)) {
                alert('Serial must be 5-20 characters (letters, numbers, underscore only)');
                return;
            }
            
            if (!/^\d{6}$/.test(pin)) {
                alert('PIN must be exactly 6 digits');
                return;
            }
            
            // Check if device already exists
            if (manufacturingDevices.some(([id]) => id === serial)) {
                alert('Device with this serial already exists');
                return;
            }
            
            try {
                const response = await fetch('/api/manufacturing/add-device', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        serial: serial,
                        pin: pin
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Device added successfully: ' + serial);
                    
                    // Add to local array
                    manufacturingDevices.push([serial, {
                        pin: pin,
                        activated: false,
                        createdDate: new Date().toISOString(),
                        activatedDate: null,
                        activatedBy: null
                    }]);
                    
                    // Clear form
                    document.getElementById('newSerial').value = '';
                    document.getElementById('newPin').value = '';
                    
                    // Refresh display
                    updateStats();
                    filterDevices();
                } else {
                    alert('Failed to add device: ' + result.error);
                }
            } catch (error) {
                alert('Error adding device: ' + error.message);
            }
        }
        
        function filterDevices() {
            const searchTerm = document.getElementById('searchSerial').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredDevices = manufacturingDevices.filter(([serial, info]) => {
                const matchesSearch = serial.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || 
                    (statusFilter === 'pending' && !info.activated) || 
                    (statusFilter === 'activated' && info.activated);
                
                return matchesSearch && matchesStatus;
            });
            
            renderDevicesTable();
        }
        
        function sortDevices() {
            const sortBy = document.getElementById('sortBy').value;
            
            filteredDevices.sort(([aSerial, aInfo], [bSerial, bInfo]) => {
                switch (sortBy) {
                    case 'serial':
                        return aSerial.localeCompare(bSerial);
                    case 'created':
                        return new Date(bInfo.createdDate || 0) - new Date(aInfo.createdDate || 0);
                    case 'status':
                        return (bInfo.activated ? 1 : 0) - (aInfo.activated ? 1 : 0);
                    default:
                        return 0;
                }
            });
            
            renderDevicesTable();
        }
        
        function renderDevicesTable() {
            const tbody = document.getElementById('devicesTableBody');
            const noDevicesMsg = document.getElementById('noDevicesMessage');
            
            if (filteredDevices.length === 0) {
                tbody.innerHTML = '';
                noDevicesMsg.style.display = 'block';
                return;
            }
            
            noDevicesMsg.style.display = 'none';
            
            tbody.innerHTML = filteredDevices.map(([serial, info]) => {
                const isSelected = selectedDevices.has(serial);
                const createdDate = info.createdDate ? new Date(info.createdDate).toLocaleDateString() : 'Unknown';
                const activatedDate = info.activatedDate ? new Date(info.activatedDate).toLocaleDateString() : '-';
                const activatedBy = info.activatedBy || '-';
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                   onchange="toggleDeviceSelection('${serial}')">
                        </td>
                        <td><strong>${serial}</strong></td>
                        <td><code>${info.pin}</code></td>
                        <td>
                            <span class="status-badge ${info.activated ? 'status-activated' : 'status-pending'}">
                                ${info.activated ? '‚úÖ Activated' : '‚è≥ Pending'}
                            </span>
                        </td>
                        <td>${createdDate}</td>
                        <td>${activatedDate}</td>
                        <td>${activatedBy}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editDevice('${serial}')" title="Edit">‚úèÔ∏è</button>
                            ${!info.activated ? `<button class="action-btn btn-activate" onclick="activateDevice('${serial}')" title="Activate">üîß</button>` : ''}
                            <button class="action-btn btn-delete" onclick="deleteDevice('${serial}')" title="Delete">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const headerCheckbox = document.getElementById('headerCheckbox');
            
            if (selectAll) {
                filteredDevices.forEach(([serial]) => selectedDevices.add(serial));
                headerCheckbox.checked = true;
            } else {
                selectedDevices.clear();
                headerCheckbox.checked = false;
            }
            
            updateSelectedCount();
            renderDevicesTable();
        }
        
        function toggleDeviceSelection(serial) {
            if (selectedDevices.has(serial)) {
                selectedDevices.delete(serial);
            } else {
                selectedDevices.add(serial);
            }
            
            updateSelectedCount();
            
            // Update select all checkbox
            const selectAll = document.getElementById('selectAll');
            const headerCheckbox = document.getElementById('headerCheckbox');
            selectAll.checked = selectedDevices.size === filteredDevices.length;
            headerCheckbox.checked = selectAll.checked;
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedDevices.size + ' selected';
        }
        
        function updateStats() {
            const total = manufacturingDevices.length;
            const activated = manufacturingDevices.filter(([, info]) => info.activated).length;
            const pending = total - activated;
            
            // Calculate today's production (devices created today)
            const today = new Date().toDateString();
            const todayProduction = manufacturingDevices.filter(([, info]) => 
                info.createdDate && new Date(info.createdDate).toDateString() === today
            ).length;
            
            document.getElementById('totalDevices').textContent = total;
            document.getElementById('pendingDevices').textContent = pending;
            document.getElementById('activatedDevices').textContent = activated;
            document.getElementById('todayProduction').textContent = todayProduction;
        }
        
        async function editDevice(serial) {
            const device = manufacturingDevices.find(([id]) => id === serial);
            if (!device) return;
            
            const newPin = prompt('Enter new PIN (6 digits):', device[1].pin);
            if (!newPin) return;
            
            if (!/^\d{6}$/.test(newPin)) {
                alert('PIN must be exactly 6 digits');
                return;
            }
            
            try {
                const response = await fetch('/api/manufacturing/edit-device', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        serial: serial,
                        pin: newPin
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    device[1].pin = newPin;
                    alert('Device updated successfully');
                    renderDevicesTable();
                } else {
                    alert('Failed to update device: ' + result.error);
                }
            } catch (error) {
                alert('Error updating device: ' + error.message);
            }
        }
        
        async function activateDevice(serial) {
            const userPhone = prompt('Enter activating user phone number (10-14 digits):');
            if (!userPhone) return;
            
            const cleanPhone = userPhone.replace(/\D/g, '');
            if (!/^\d{10,14}$/.test(cleanPhone)) {
                alert('Please enter a valid phone number (10-14 digits)');
                return;
            }
            
            const device = manufacturingDevices.find(([id]) => id === serial);
            if (!device) return;
            
            try {
                const response = await fetch('/api/device/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        serial: serial,
                        pin: device[1].pin,
                        activating_user: cleanPhone
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    device[1].activated = true;
                    device[1].activatedDate = new Date().toISOString();
                    device[1].activatedBy = cleanPhone;
                    
                    alert('Device activated successfully!\nSerial: ' + serial + '\nUser: ' + cleanPhone);
                    updateStats();
                    renderDevicesTable();
                } else {
                    alert('Activation failed: ' + result.error);
                }
            } catch (error) {
                alert('Error activating device: ' + error.message);
            }
        }
        
        async function deleteDevice(serial) {
            if (!confirm('Delete device ' + serial + '?\n\nThis action cannot be undone!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/manufacturing/delete-device', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serial: serial })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    manufacturingDevices = manufacturingDevices.filter(([id]) => id !== serial);
                    selectedDevices.delete(serial);
                    
                    alert('Device deleted successfully');
                    updateStats();
                    updateSelectedCount();
                    filterDevices();
                } else {
                    alert('Failed to delete device: ' + result.error);
                }
            } catch (error) {
                alert('Error deleting device: ' + error.message);
            }
        }
        
        async function bulkActivate() {
            if (selectedDevices.size === 0) {
                alert('Please select devices to activate');
                return;
            }
            
            const userPhone = prompt('Enter activating user phone number (10-14 digits) for all selected devices:');
            if (!userPhone) return;
            
            const cleanPhone = userPhone.replace(/\D/g, '');
            if (!/^\d{10,14}$/.test(cleanPhone)) {
                alert('Please enter a valid phone number (10-14 digits)');
                return;
            }
            
            if (!confirm(`Activate ${selectedDevices.size} devices with user ${cleanPhone}?`)) {
                return;
            }
            
            let successCount = 0;
            let failCount = 0;
            
            for (const serial of selectedDevices) {
                const device = manufacturingDevices.find(([id]) => id === serial);
                if (!device || device[1].activated) continue;
                
                try {
                    const response = await fetch('/api/device/activate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            serial: serial,
                            pin: device[1].pin,
                            activating_user: cleanPhone
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        device[1].activated = true;
                        device[1].activatedDate = new Date().toISOString();
                        device[1].activatedBy = cleanPhone;
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
            }
            
            alert(`Bulk activation complete!\nSuccess: ${successCount}\nFailed: ${failCount}`);
            
            selectedDevices.clear();
            updateStats();
            updateSelectedCount();
            renderDevicesTable();
        }
        
        async function bulkDelete() {
            if (selectedDevices.size === 0) {
                alert('Please select devices to delete');
                return;
            }
            
            if (!confirm(`Delete ${selectedDevices.size} selected devices?\n\nThis action cannot be undone!`)) {
                return;
            }
            
            let successCount = 0;
            let failCount = 0;
            
            for (const serial of selectedDevices) {
                try {
                    const response = await fetch('/api/manufacturing/delete-device', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ serial: serial })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        manufacturingDevices = manufacturingDevices.filter(([id]) => id !== serial);
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
            }
            
            alert(`Bulk deletion complete!\nDeleted: ${successCount}\nFailed: ${failCount}`);
            
            selectedDevices.clear();
            updateStats();
            updateSelectedCount();
            filterDevices();
        }
        
        function exportDevices() {
            const csvContent = [
                ['Serial', 'PIN', 'Status', 'Created Date', 'Activated Date', 'Activated By'].join(','),
                ...manufacturingDevices.map(([serial, info]) => [
                    serial,
                    info.pin,
                    info.activated ? 'Activated' : 'Pending',
                    info.createdDate ? new Date(info.createdDate).toISOString() : '',
                    info.activatedDate ? new Date(info.activatedDate).toISOString() : '',
                    info.activatedBy || ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'manufacturing-devices-' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        
        // Initialize
        updateStats();
        filteredDevices = [...manufacturingDevices];
        renderDevicesTable();
        updateSelectedCount();
    </script>
    <script src="/public/common.js"></script>
</body>
</html>
